<div class="card shadow-sm rounded">
  <form [formGroup]="form">
    <div class="p-3">
      <div class="d-flex">
        <h2 class="roboto text-muted mr-auto mb-0 pb-0">
          Solicitação n°{{f.id.value | number:'3.0'}}
        </h2>
        <h4 class="roboto text-muted mb-0 pb-0 mt-2">
          Data: {{dataHoje | DateTimeFormatter}}
        </h4>
      </div>
      <hr class="mt-1">

      <div *ngIf="IsCotacaoEncerrada" class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Cotação Encerrada!</h4>
        Um fornecedor já foi escolhido para essa compra portanto alterações não podem ser feitas.
      </div>

      <div class="form-row mt-3">
        <div class="form-group col-md-1">
          <label>Código</label>
          <input type="text" class="form-control" readonly
          formControlName="id">
        </div>

        <div class="form-group col-md-4">
          <label>Solicitante</label>
          <input type="text" class="form-control"
          readonly formControlName="user">
        </div>

        <div class="form-group col-md-2">
          <label>Prazo de Necessidade</label>
          <input
        class="form-control" readonly
        formControlName="dataNecessidade">
        </div>

        <div class="form-group col-md-2">
          <label>Família de Produtos</label>
          <input readonly
        class="form-control"
        formControlName="DesFamProd">
        </div>

        <div class="form-group col-md-2">
          <label>Prazo da Cotação</label>
          <input class="form-control" bsDatepicker
          [ngClass]="cssValidation(f.prazoCotacao)"
          formControlName="prazoCotacao"
          [minDate]="dataHoje" [isDisabled]="CantChange"
          [bsConfig]="bsConfig" [readonly]="CantChange">
          <div *ngIf="f.prazoCotacao.errors?.required" class="invalid-feedback">
            O campo Prazo de Cotação é obrigatório
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-2">
          <label>Cotador</label>
          <input type="text" class="form-control"
          readonly formControlName="cotador">
        </div>
        <div class="form-group col-md-2">
          <label>Frm Pagamento</label>
          <select class="form-control" [ngClass]="cssValidation(f.familiaProdutoId)" [(ngModel)]="familiaId"
            formControlName="frmPagamento" >
						<option value=""></option>
						<option value="0">1x</option>
						<option value="1">2x</option>
						<option value="2">3x</option>
						<option value="3">4x</option>
						<option value="4">5x</option>
					</select>
          <div *ngIf="f.frmPagamento.errors?.required" class="invalid-feedback">
            O campo Frm Pagamento é obrigatório
          </div>
        </div>
      </div>

    <div *ngIf="!cotacoes || !cotacoes.length">
      <div class="d-flex mt-4 ">
        <h2 class="roboto text-muted mr-auto mb-0 pb-0 ">
          Itens
        </h2>
      </div>
      <hr class="mt-2">

      <table class="table table-striped table-hover">
        <thead class="bg-logo">
          <tr>
            <th class="d-none d-md-table-cell text-center">Código</th>
            <th class="text-center">Descrição</th>
            <th class="text-center d-none d-md-table-cell">Unid. Medida</th>
            <th class="text-center">Quantidade</th>
          </tr>
        </thead>
        <tbody *ngIf="solicitacaoProdutos && solicitacaoProdutos.length">
          <tr *ngFor="let item of solicitacaoProdutos">
            <td class="d-none d-md-table-cell text-center" style="width: 10%">
              {{item.produto?.id}}
            </td>
            <td class="text-center" style="width: 50%">
              {{item.produto?.descricao}}
            </td>
            <td class="d-none d-md-table-cell text-center" style="width: 20%">
              {{item.produto?.unidMedida}}
            </td>
            <td class="text-center" style="width: 10%">
              {{item.qtdeProduto}}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="(!cotacoes || !cotacoes.length)">
      <div class="d-flex mt-4">
        <h2 class="roboto text-muted mr-auto mb-0 pb-0 ">
          Fornecedores
        </h2>
      </div>
      <hr class="mt-2">

      <div *ngIf="fornecedoresEscolhidos && fornecedoresEscolhidos.length" class="row justify-content-around mt-2">
        <div *ngFor="let fornecedor of fornecedoresEscolhidos" class="col-lg-4 pt-1">
          <div class="card mb-3 shadow">
            <div class="card-header text-center" style="background-color: #2E3C5A;">
              <h4 class="text-light m-0">Fornecedor</h4>
            </div>
            <div class="card-body">
              <div class="h4 text-center my-3">{{fornecedor.nome}}</div>
              <div class="h7 text-center text-bold pb-1"><b>Ranking: </b>{{fornecedor.posicao}}°</div>
              <div class="h7 text-center text-bold pb-1"><b>E-mail: </b>{{fornecedor.email}}</div>
              <div class="h7 text-center text-bold pb-1"><b>Telefone:</b>{{fornecedor.telefone}}</div>
              <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-outline-info" (click)="OpenModalFornecedores(SelecaoFornecedor, fornecedor.id)">
                  <div class="d-flex">
                    <i class="fas fa-sync-alt fa-lg my-1"></i>
                    <p class="ml-1 my-0">Substituir</p>
                  </div>
                </button>
                <!-- <button class="btn btn-success">
                  <div class="d-flex">
                    <i class="fas fa-paper-plane fa-lg my-1"></i>
                    <p class="ml-1 my-0">Enviar</p>
                  </div>
                </button> -->
            </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!fornecedoresRanking.length">
        <div class="d-flex justify-content-center">
          <h3>Ainda não há fornecedores cadastrados para essa família!</h3>
        </div>
        <div class="d-flex justify-content-center">
          <button class="btn btn-primary" (click)="NavigateToFornecedor()">
            <div class="d-flex">
              <i class="fas fa-plus-circle fa-lg my-1"></i>
              <p class="ml-1 my-0">Cadastrar Fornecedor</p>
            </div>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="ShowAlert" class="alert alert-warning" role="alert">
      <h4 class="alert-heading">Nenhuma Oferta Recebida!</h4>
      As Cotações já foram enviadas aos Fornecedores, mas nenhuma Oferta foi recebida até o momento.
    </div>
  <div *ngIf="ShowCotacaoes" [formGroup]="form">
    <div *ngFor="let cotacao of cotacoes; let i= index" formArrayName="cotacoes"  >
        <div *ngIf="cotacao.status != 1" class="card shadow-sm pb-2 mb-1 px-3" [ngClass]="cssGetIdeal(cotacao.fornecedorId)" [formGroupName]="i" >
          <div class="d-flex mt-4 ">
            <h2 class="roboto mb-0 pb-0" [ngClass]="cssTextIdeal(cotacao.fornecedorId)">
              Cotação n°{{cotacao.id | number:'3.0'}}
            </h2>
            <i *ngIf="GetTypeIdeal(cotacao?.fornecedorId) == 0" class="fas fa-medal fa-2x text-success align-self-baseline ml-2"></i>
            <i *ngIf="GetTypeIdeal(cotacao?.fornecedorId) == 1" tooltip="Fornecedor tem o melhor Preço" class="fas fa-dollar-sign fa-2x text-success align-self-baseline ml-2"></i>
            <i *ngIf="GetTypeIdeal(cotacao?.fornecedorId) == 2" tooltip="Fornecedor tem a melhor Data de Entrega" class="far fa-calendar-alt fa-2x text-success align-self-baseline ml-2"></i>
            <i class="fa-2x text-logo pr-2 align-text-bottom ml-auto" [ngClass]="cssRotate(!cotacao.isCollapsed)" (click)="cotacao.isCollapsed = !cotacao.isCollapsed" style="cursor: pointer;"></i>
          </div>
          <hr class="mt-2">

          <div [collapse]="!cotacao.isCollapsed" [isAnimated]="true">
            <div class="row">
            <div class="form-group col-md-4">
              <label>Fornecedor</label>
              <input type="text" class="form-control"
              readonly formControlName="fornecedor">
            </div>

            <div class="form-group col-md-2">
              <label>Data de Entrega</label>
              <input type="text" class="form-control"
              readonly formControlName="dataEntrega">
            </div>

            <div class="form-group col-md-2">
              <label>Frete</label>
              <input type="text" class="form-control"
              readonly formControlName="frete">
            </div>
          </div>

          <table class="table table-striped table-hover">
            <thead class="bg-logo">
              <tr>
                <th class="d-none d-md-table-cell text-center">Código</th>
                <th class="text-center">Descrição</th>
                <th class="text-center d-none d-md-table-cell">Unid. Medida</th>
                <th class="text-center">Quantidade</th>
                <th class="text-center">Preço Unit.</th>
                <th class="text-center">Total Produto</th>
              </tr>
            </thead>
            <tbody *ngIf="cotacao.itensCotacao && cotacao.itensCotacao.length">
              <tr *ngFor="let item of cotacao.itensCotacao" >
                <td class="d-none d-md-table-cell text-center" style="width: 10%">
                  {{setSolProdItem(item.idSolicitacaoProduto)}}
                </td>
                <td class="text-center" style="width: 40%">
                  {{solProdItem.produto?.descricao}}
                </td>
                <td class="d-none d-md-table-cell text-center" style="width: 12%">
                  {{solProdItem.produto?.unidMedida}}
                </td>
                <td class="text-center" style="width: 10%">
                  {{item.qtdeProduto}}
                </td>
                <td class="text-center" style="width: 10%">
                  {{item.precoUnit | currency : 'R$'}}
                </td>
                <td class="text-center" style="width: 15%">
                  {{item.qtdeProduto * item.precoUnit | currency : 'R$'}}
                </td>
              </tr>
            </tbody>
          </table>
          <div class="row align-items-end justify-content-end">
            <button *ngIf="!IsCotacaoEncerrada" class="btn btn-success" (click)="GerarPedido(cotacao.id)">
              <div class="d-flex">
                <i class="fas fa-file-invoice-dollar fa-lg my-1"></i>
                <p class="ml-1 my-0">Gerar Pedido</p>
              </div>
            </button>
            <div class="col-2">
              <label>Valor Total</label>
              <input type="text" class="form-control"
              readonly formControlName="total">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


    </div>

    <div class="card-footer">
      <div class="d-flex justify-content-end">
        <button class="btn btn-outline-secondary border" (click)="OpenModalCancel(CancelarTemplate)">
          Cancelar Alteração
        </button>

        <button *ngIf="!cotacoes.length" class="ml-auto btn btn-success" [disabled]="!form.valid" (click)="EnviarCotacoes()">
          <div class="d-flex">
            <i class="fas fa-paper-plane fa-lg my-1"></i>
            <p class="ml-1 my-0">Enviar aos Fornecedores</p>
          </div>
        </button>
      </div>
    </div>
  </form>
  </div>

  <ng-template #SelecaoFornecedor>
    <div class="modal-header">
      <h5 class="modal-title">Selecione um Fornecedor</h5>
    </div>

    <div class="modal-body">

      <h2 class="roboto text-muted mr-auto mb-0 pb-0 ">
        Fornecedores
      </h2>
      <hr>
      <div class="d-flex">
        <div class="flex-grow-1 pr-2">
          <div class="input-group mb-2">
            <input type="text"
            class="form-control"
            placeholder="Filtrar pelo Nome"
            [(ngModel)]="GridFilter">
            <div class="input-group-append">
              <div class="input-group-text bg-logo">
                <i class="fas fa-filter"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <table class="table table-striped table-hover">
        <thead class="bg-logo">
          <tr>
            <th class="d-none d-md-table-cell text-center">Ranking</th>
            <th class="d-none d-md-table-cell text-center">Código</th>
            <th class="text-center">Nome</th>
            <th class="text-center">Opções</th>
          </tr>
        </thead>
        <tbody *ngIf="fornecedoresRanking && fornecedoresRanking.length">
          <tr *ngFor="let fornecedor of fornecedoresRanking">
            <td class="d-none d-md-table-cell text-center" style="width: 10%">
              {{fornecedor.posicao}}°
            </td>
            <td class="text-center" style="width: 10%">
              {{fornecedor.id | number:'3.0'}}
            </td>
            <td class="d-none d-md-table-cell text-left" style="width: 50%">
              {{fornecedor.nome}}
            </td>
            <td class="text-center" style="width: 20%">
                <i class="fas fa-plus fa-2x text-info" style="cursor: pointer;" (click)="SubstituirFornecedor(fornecedor.id)"></i>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="CloseModalFornecedores()">Fechar</button>
    </div>
</ng-template>

  <!-- <ng-template #AprovarSolicitacao>
    <app-aprovar-solicitacao [modal]="modalRefAprovaca" [solicitacao]="solicitacao" (carregaEventos)="onMudouEvento($event)"></app-aprovar-solicitacao>
  </ng-template> -->

  <ng-template #CancelarTemplate>
    <div class="modal-body text-center">
      <p>Deseja realmente Cancelar o registro da Cotação? <br>
         Você perderá todos os dados não salvos</p>
      <button type="button" class="btn btn-default" (click)="CancelarForm()">Sim</button>
      <button type="button" class="btn btn-primary" (click)="declineCancel()">Não</button>
    </div>
  </ng-template>


